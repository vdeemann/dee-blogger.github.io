#!/bin/bash
set -e

rm -rf public
mkdir -p public/p

echo "Building hyper-optimized blog..."

# Generate individual post pages
i=1
for f in content/*.md; do
    [ -f "$f" ] || continue
    
    filename=$(basename "$f")
    date_part=$(echo "$filename" | cut -d- -f1-3)
    year=$(echo "$date_part" | cut -d- -f1)
    month=$(echo "$date_part" | cut -d- -f2)  
    day=$(echo "$date_part" | cut -d- -f3)
    month=${month#0}
    day=${day#0}
    short_date="$month/$day/${year#20}"
    title=$(head -1 "$f" | sed 's/^# //')
    
    # Enhanced content processing
    content=$(tail -n +3 "$f" | sed '
        s/^$/<p>/
        s/^## \(.*\)/<h2>\1<\/h2>/
        s/^\*\*\([^*]*\)\*\*:/<strong>\1:<\/strong>/
        s/\*\*\([^*]*\)\*\*/<strong>\1<\/strong>/g
        s/^- /<p>‚Ä¢ /
        s/^[^<#*]/<p>&/
    ')
    
    # Hyper-optimized template (maintains all visuals)
    cat > "public/p/$i.html" << EOF
<!DOCTYPE html><title>$title</title><style>body{max-width:40em;margin:2em auto;padding:0 1em;font-family:system-ui,sans-serif;line-height:1.6;color:#333}a{color:#06c}a:hover{text-decoration:underline}h1{font-size:1.8em;margin-bottom:.5em}h2{font-size:1.3em;margin:2em 0 1em;color:#222}p{margin-bottom:1em}small{color:#666;display:block;margin-bottom:1em}pre{background:#f8f8f8;padding:1em;margin:1.5em 0;border-radius:4px;overflow-x:auto;border-left:3px solid #ddd}code{font-family:monospace;font-size:.9em}strong{font-weight:600}nav{margin:1.5em 0;padding:.5em 0;border-bottom:1px solid #eee}nav a{text-decoration:none}</style><nav><a href="../">‚Üê Blog</a></nav><h1>$title</h1><small>$short_date</small>$content<nav style="border-top:1px solid #eee;border-bottom:0"><a href="../">‚Üê Back to Blog</a></nav>
EOF
    
    size=$(wc -c < "public/p/$i.html")
    echo "Generated post $i: $title ($size bytes)"
    ((i++))
done

# Generate hyper-optimized main index
{
    echo '<!DOCTYPE html><title>My Blog</title><style>body{max-width:40em;margin:2em auto;padding:0 1em;font-family:system-ui,sans-serif;line-height:1.6;color:#333}input{width:100%;margin-bottom:1em;padding:.5em;border:1px solid #ddd;border-radius:4px}small{color:#666;display:block;margin:0}h2{margin:0}a{color:#06c;text-decoration:none}a:hover{text-decoration:underline}.post{margin-bottom:2em;padding:1em;background:#fafafa;border-radius:4px}</style><h1>My Blog</h1><input id=s placeholder="Search posts..." onkeyup="f()"><div id=p>'
    
    i=1
    for f in content/*.md; do
        [ -f "$f" ] || continue
        filename=$(basename "$f")
        date_part=$(echo "$filename" | cut -d- -f1-3)
        year=$(echo "$date_part" | cut -d- -f1)
        month=$(echo "$date_part" | cut -d- -f2)
        day=$(echo "$date_part" | cut -d- -f3)
        month=${month#0}
        day=${day#0}
        short_date="$month/$day/${year#20}"
        title=$(head -1 "$f" | sed 's/^# //')
        excerpt=$(sed -n '3p' "$f")
        echo "<div class=post><small>$short_date</small><h2><a href=\"p/$i.html\">$title</a></h2>$excerpt</div>"
        ((i++))
    done
    
    echo '</div><script>let o,p=document.getElementById("p");function f(){let q=s.value.toLowerCase();if(!o)o=p.innerHTML;if(!q){p.innerHTML=o;return}let r=Array.from(p.children).filter(e=>e.textContent.toLowerCase().includes(q));p.innerHTML=r.length?r.map(e=>e.outerHTML).join(""):"<div class=post><p>No posts found</p></div>"}</script>'
} > public/index.html

post_count=$(ls content/*.md 2>/dev/null | wc -l)
total_size=$(du -sh public/ 2>/dev/null | cut -f1 || echo "N/A")
echo "‚úÖ Built $post_count posts (hyper-optimized)"
echo "üì¶ Total size: $total_size"
echo "üé® All visuals preserved"
echo "üöÄ Maximum optimization achieved!"
