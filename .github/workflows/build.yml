name: Build and Deploy Blog

on:
  push:
    branches: [main]
    paths: ['content/**', 'build.sh', '.github/workflows/**']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  SITE_TITLE: "dee-blogger"

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Validate content
        run: |
          if [ ! -d "content" ]; then
            echo "❌ No content directory found"
            exit 1
          fi
          
          post_count=$(find content -name "*.md" | wc -l)
          if [ "$post_count" -eq 0 ]; then
            echo "❌ No markdown files found in content/"
            exit 1
          fi
          
          echo "✅ Found $post_count markdown files"
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Build blog
        run: |
          chmod +x build.sh
          export SITE_TITLE="${{ env.SITE_TITLE }}"
          export BASE_URL="${{ steps.pages.outputs.base_url }}"
          ./build.sh
          
      - name: Validate build output
        run: |
          if [ ! -f "public/index.html" ]; then
            echo "❌ Main index.html not generated"
            exit 1
          fi
          
          if [ ! -f "public/archive/index.html" ]; then
            echo "❌ Archive index.html not generated"
            exit 1
          fi
          
          post_count=$(find public/p -name "*.html" 2>/dev/null | wc -l)
          total_size=$(du -sb public | cut -f1)
          
          echo "✅ Build validation completed"
          echo "📊 Stats:"
          echo "  - Posts: $post_count"
          echo "  - Total size: $(( total_size / 1024 )) KB"
          echo "  - Files: $(find public -type f | wc -l)"
          
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Build summary
        run: |
          echo "🚀 Deployment completed successfully!"
          echo "🌐 Site URL: ${{ steps.deployment.outputs.page_url }}"
