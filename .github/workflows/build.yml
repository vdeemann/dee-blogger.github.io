name: 🚀 SAFE EXTREME BUILD - GITHUB ACTIONS COMPATIBLE

on:
  push:
    branches: [main]
    paths: ['content/**', 'build.sh']
  workflow_dispatch:

permissions: 
  contents: read
  pages: write
  id-token: write

concurrency:
  group: safe-extreme-build
  cancel-in-progress: true

env:
  SITE_TITLE: dee-blogger
  DEBIAN_FRONTEND: noninteractive
  FORCE_COLOR: 0
  CI: true

jobs:
  safe-extreme-build:
    runs-on: ubuntu-latest
    environment: 
      name: github-pages
      url: '${{ steps.deploy.outputs.page_url }}'
    steps:
    - uses: actions/checkout@v4
      with: 
        fetch-depth: 1
        show-progress: false

    - name: 🚀 SAFE EXTREME OPTIMIZATION
      run: |
        # Safe memory optimizations for GitHub Actions
        export MALLOC_ARENA_MAX=2
        export OMP_NUM_THREADS=$(nproc)
        ulimit -n 32768 2>/dev/null || true
        
        # Environment acceleration
        export SITE_TITLE="dee-blogger"
        export BASE_URL="https://vdeemann.github.io/dee-blogger.github.io"
        export LC_ALL=C LANG=C TZ=UTC
        
        # Build with maximum parallelization
        echo "🚀 Building with $(nproc) CPU cores"
        time (chmod +x build.sh && nice -n -10 ./build.sh)
        
        # Parallel compression using available tools
        echo "🗜️ Compressing with $(nproc) threads"
        find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | \
        xargs -P$(nproc) -I{} sh -c 'gzip -9 "$1" && touch -r "$1.gz" "$1"' _ {}
        
        # Performance metrics
        TOTAL_SIZE=$(du -sb public | cut -f1)
        PAGE_COUNT=$(find public -name "*.html" | wc -l)
        COMPRESSED=$(find public -name "*.gz" | wc -l)
        
        echo "🚀 SAFE EXTREME BUILD COMPLETE:"
        echo "📊 Size: $((TOTAL_SIZE/1024)) KB"
        echo "📄 Pages: $PAGE_COUNT"
        echo "🗜️ Compressed: $COMPRESSED files"
        echo "⚡ Efficiency: $(echo "scale=1;$TOTAL_SIZE/1024/$PAGE_COUNT" | bc) KB/page"

    - name: 🚀 DEPLOY
      id: deploy
      uses: actions/deploy-pages@v4
      with: 
        path: ./public

    - run: echo "🚀 SAFE EXTREME BUILD SUCCESS → ${{ steps.deploy.outputs.page_url }}"
