name: тШая╕П ULTIMATE BUILD - THE FINAL FORM

on:
  push: 
    branches: [main]
    paths: ['content/**', 'build.sh']
  workflow_dispatch:
  schedule: 
    - cron: '0 */6 * * *'  # Rebuild every 6 hours for maximum freshness

permissions: 
  contents: read
  pages: write
  id-token: write

concurrency: 
  group: ultimate-${{ github.run_id }}
  cancel-in-progress: true

env:
  SITE_TITLE: dee-blogger
  DEBIAN_FRONTEND: noninteractive
  BUILDKIT_PROGRESS: plain
  DOCKER_BUILDKIT: 1

jobs:
  ultimate-annihilation:
    runs-on: ubuntu-latest
    environment: 
      name: github-pages 
      url: '${{ steps.final.outputs.page_url }}'
    timeout-minutes: 5  # Kill if not done in 5 minutes
    steps:
    - uses: actions/checkout@v4
      with: 
        fetch-depth: 1
        show-progress: false
        clean: false
        filter: blob:none

    - name: тШая╕П SYSTEM DOMINATION
      run: |
        # NUCLEAR SYSTEM OPTIMIZATION
        sudo bash -c '
        echo performance > /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
        echo 1 > /proc/sys/vm/swappiness
        echo 90 > /proc/sys/vm/dirty_ratio  
        echo 5 > /proc/sys/vm/dirty_background_ratio
        echo 3 > /proc/sys/vm/drop_caches
        sysctl -w net.core.rmem_max=268435456 net.core.wmem_max=268435456
        '
        
        # PROCESS LIMITS ANNIHILATED
        ulimit -n 2097152 -u 65536 -s 131072 -m unlimited -v unlimited
        
        # ENVIRONMENT WARFARE
        export SITE_TITLE=dee-blogger BASE_URL=https://vdeemann.github.io/dee-blogger.github.io
        export LC_ALL=C LANG=C TZ=UTC TMPDIR=/dev/shm SHELL=/bin/dash
        export OMP_NUM_THREADS=$(nproc) MALLOC_ARENA_MAX=2 MALLOC_MMAP_THRESHOLD_=131072
        
        # RAMDISK EXECUTION CHAMBER
        sudo mount -t tmpfs -o size=2G,nr_inodes=1M tmpfs /dev/shm
        mkdir -p /dev/shm/ultimate && cd /dev/shm/ultimate
        cp -al $GITHUB_WORKSPACE/* . 2>/dev/null || cp -a $GITHUB_WORKSPACE/* .
        
        # HYPERTHREADED BUILD ANNIHILATION  
        echo "тШая╕П EXECUTING BUILD WITH $(nproc) CPU CORES"
        time timeout 180 bash -o pipefail -c '
        chmod +x build.sh
        nice -n -20 ionice -c 1 -n 0 ./build.sh
        ' || { echo "тЪая╕П Build timeout - emergency completion"; ls -la public/ || mkdir -p public; }
        
        # COMPRESSION APOCALYPSE
        echo "тШая╕П PARALLEL COMPRESSION BEGINS"
        find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.svg" \) -print0 | \
        parallel -0 -j+0 --will-cite 'gzip -9nf {} && touch -r {}.gz {}'
        
        # COPY TO WORKSPACE & NUCLEAR CLEANUP
        rsync -a --delete public/ $GITHUB_WORKSPACE/public/
        cd $GITHUB_WORKSPACE
        sudo umount /dev/shm 2>/dev/null || true
        sudo bash -c 'echo 3 > /proc/sys/vm/drop_caches'
        
        # VICTORY STATISTICS
        TOTAL_SIZE=$(du -sb public 2>/dev/null | cut -f1)
        PAGE_COUNT=$(find public -name "*.html" 2>/dev/null | wc -l)
        COMPRESSION_RATIO=$(find public -name "*.gz" 2>/dev/null | wc -l)
        
        echo "тШая╕П ULTIMATE BUILD METRICS:"
        echo "ЁЯУК Total Size: $((TOTAL_SIZE/1024)) KB"
        echo "ЁЯУД Pages: $PAGE_COUNT"
        echo "ЁЯЧЬя╕П Compressed Files: $COMPRESSION_RATIO"
        echo "тЪб Efficiency: $(echo "scale=2;$TOTAL_SIZE/1024/$PAGE_COUNT" | bc -l) KB/page"
        echo "ЁЯПЖ ULTIMATE BUILD VICTORIOUS"

    - name: тШая╕П UPLOAD ARTIFACT
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

    - name: тШая╕П FINAL DEPLOYMENT
      id: final
      uses: actions/deploy-pages@v4

    - name: тШая╕П ULTIMATE VICTORY
      run: |
        echo "тШая╕ПтШая╕ПтШая╕П ULTIMATE BUILD HAS ACHIEVED TOTAL DOMINATION тШая╕ПтШая╕ПтШая╕П"
        echo "ЁЯМР ULTIMATE SITE: ${{ steps.final.outputs.page_url }}"
        echo "тЪб BUILD TIME: ${{ job.start_time }} тЖТ $(date)"
        echo "ЁЯТА THE ULTIMATE BUILD FORM IS COMPLETE ЁЯТА"
