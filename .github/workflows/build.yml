name: ‚ò†Ô∏è ULTIMATE BUILD - THE FINAL FORM

on:
  push: 
    branches: [main]
    paths: ['content/**', 'build.sh']
  workflow_dispatch:
  schedule: 
    - cron: '0 */6 * * *'  # Rebuild every 6 hours for maximum freshness

permissions: 
  contents: read
  pages: write
  id-token: write

concurrency: 
  group: ultimate-${{ github.run_id }}
  cancel-in-progress: true

env:
  SITE_TITLE: dee-blogger
  DEBIAN_FRONTEND: noninteractive
  BUILDKIT_PROGRESS: plain
  DOCKER_BUILDKIT: 1

jobs:
  ultimate-annihilation:
    runs-on: ubuntu-latest
    environment: 
      name: github-pages 
      url: '${{ steps.final.outputs.page_url }}'
    timeout-minutes: 5  # Kill if not done in 5 minutes
    steps:
    - uses: actions/checkout@v4
      with: 
        fetch-depth: 1
        show-progress: false
        clean: false
        filter: blob:none

    - name: Install GNU parallel
      run: sudo apt-get update && sudo apt-get install -y parallel

    - name: ‚ò†Ô∏è SYSTEM DOMINATION
      run: |
        # NUCLEAR SYSTEM OPTIMIZATION
        sudo bash -c '
        echo performance > /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true
        echo 1 > /proc/sys/vm/swappiness || true
        echo 90 > /proc/sys/vm/dirty_ratio  || true
        echo 5 > /proc/sys/vm/dirty_background_ratio || true
        echo 3 > /proc/sys/vm/drop_caches || true
        sysctl -w net.core.rmem_max=268435456 net.core.wmem_max=268435456 || true
        '
        
        # PROCESS LIMITS ANNIHILATED
        ulimit -n 2097152 -u 65536 -s 131072 -m unlimited -v unlimited || true
        
        # ENVIRONMENT WARFARE
        export SITE_TITLE=dee-blogger BASE_URL=https://vdeemann.github.io/dee-blogger.github.io
        export LC_ALL=C LANG=C TZ=UTC TMPDIR=/dev/shm SHELL=/bin/dash
        export OMP_NUM_THREADS=$(nproc) MALLOC_ARENA_MAX=2 MALLOC_MMAP_THRESHOLD_=131072
        
        # RAMDISK EXECUTION CHAMBER
        sudo mount -t tmpfs -o size=2G,nr_inodes=1M tmpfs /dev/shm || true
        mkdir -p /dev/shm/ultimate && cd /dev/shm/ultimate
        cp -a $GITHUB_WORKSPACE/. . # Properly copy everything, including dotfiles
        
        # HYPERTHREADED BUILD ANNIHILATION  
        echo "‚ò†Ô∏è EXECUTING BUILD WITH $(nproc) CPU CORES"
        START_TIME=$(date)
        time timeout 180 bash -o pipefail -c '
        chmod +x build.sh
        nice -n -20 ionice -c 1 -n 0 ./build.sh
        ' || { echo "‚ö†Ô∏è Build timeout - emergency completion"; ls -la public/ || mkdir -p public; }
        
        # COMPRESSION APOCALYPSE
        echo "‚ò†Ô∏è PARALLEL COMPRESSION BEGINS"
        if [ -d public ]; then
          find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.svg" \) -print0 | \
          parallel -0 -j+0 --will-cite 'gzip -9nf {} && touch -r {}.gz {}'
        else
          echo "‚ö†Ô∏è public/ directory missing after build"
        fi
        
        # COPY TO WORKSPACE & NUCLEAR CLEANUP
        if [ -d public ]; then
          rsync -a --delete public/ $GITHUB_WORKSPACE/public/
        fi
        cd $GITHUB_WORKSPACE
        sudo umount /dev/shm 2>/dev/null || true
        sudo bash -c 'echo 3 > /proc/sys/vm/drop_caches' || true
        
        # VICTORY STATISTICS
        TOTAL_SIZE=$(du -sb public 2>/dev/null | cut -f1)
        PAGE_COUNT=$(find public -name "*.html" 2>/dev/null | wc -l)
        COMPRESSION_RATIO=$(find public -name "*.gz" 2>/dev/null | wc -l)
        
        echo "‚ò†Ô∏è ULTIMATE BUILD METRICS:"
        echo "üìä Total Size: $((TOTAL_SIZE/1024)) KB"
        echo "üìÑ Pages: $PAGE_COUNT"
        echo "üóúÔ∏è Compressed Files: $COMPRESSION_RATIO"
        if [ "$PAGE_COUNT" -gt 0 ]; then
          echo "‚ö° Efficiency: $(echo "scale=2;$TOTAL_SIZE/1024/$PAGE_COUNT" | bc -l) KB/page"
        fi
        echo "üèÜ ULTIMATE BUILD VICTORIOUS"
        echo "BUILD_START=$START_TIME" >> $GITHUB_ENV

    - name: ‚ò†Ô∏è UPLOAD ARTIFACT
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

    - name: ‚ò†Ô∏è FINAL DEPLOYMENT
      id: final
      uses: actions/deploy-pages@v4

    - name: ‚ò†Ô∏è ULTIMATE VICTORY
      run: |
        echo "‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è ULTIMATE BUILD HAS ACHIEVED TOTAL DOMINATION ‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è"
        echo "üåê ULTIMATE SITE: ${{ steps.final.outputs.page_url }}"
        echo "‚ö° BUILD TIME: $BUILD_START ‚Üí $(date)"
        echo "üíÄ THE ULTIMATE BUILD FORM IS COMPLETE üíÄ"
